<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Botany Election</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'SolaimanLipi', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
        }
        .stat-card.winner {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
            justify-content: center;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 150px;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .tabs {
            display: flex;
            background: #34495e;
            padding: 0 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 15px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        .tab.active {
            border-bottom-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }
        .tab-content {
            display: none;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .results-grid {
            display: grid;
            gap: 15px;
        }
        .candidate-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
            transition: all 0.3s ease;
        }
        .candidate-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .candidate-card.winner {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #fff, #e8f5e8);
        }
        .candidate-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .candidate-marker {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2em;
        }
        .candidate-info {
            flex-grow: 1;
        }
        .candidate-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .vote-count {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .voters-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .voter-item {
            background: white;
            padding: 15px;
            margin: 8px 0;
            border-radius: 10px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .voter-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .message-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            color: #856404;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background: #27ae60; }
        .status-offline { background: #e74c3c; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }
        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div id="notification" class="notification" style="display: none;"></div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-container">
        <div class="header">
            <h1>üèÜ Botany Election Admin Panel</h1>
            <p>‡¶¨‡ßã‡¶ü‡¶æ‡¶®‡¶ø ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶® ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ - ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</p>
            <div style="margin-top: 10px;">
                <span class="status-indicator status-online" id="status-indicator"></span>
                <span id="connection-status">Firebase Connected</span>
            </div>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div>‡¶Æ‡ßã‡¶ü ‡¶≠‡ßã‡¶ü</div>
                <div class="stat-number" id="total-votes">0</div>
                <div>‡¶ü‡¶ø ‡¶≠‡ßã‡¶ü</div>
            </div>
            <div class="stat-card">
                <div>‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</div>
                <div class="stat-number">39</div>
                <div>‡¶ú‡¶®</div>
            </div>
            <div class="stat-card winner" id="winner-card">
                <div>üèÜ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶ø‡¶ú‡¶Ø‡¶º‡ßÄ</div>
                <div class="stat-number" id="winner-name">-</div>
                <div id="winner-votes">0 ‡¶≠‡ßã‡¶ü</div>
            </div>
            <div class="stat-card">
                <div>‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</div>
                <div class="stat-number" id="results-status">‡¶ó‡ßã‡¶™‡¶®</div>
                <div id="settings-info">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="loadResults()">üîÑ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂</button>
            <button class="btn btn-success" onclick="exportToExcel()">üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤</button>
            <button class="btn btn-info" onclick="toggleResultsPublish()" id="publish-btn">üì¢ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂</button>
            <button class="btn btn-danger" >üóëÔ∏è ‡¶∏‡¶¨ ‡¶≠‡ßã‡¶ü ‡¶°‡¶ø‡¶≤‡ßá‡¶ü</button>
        </div>

        <div class="message-box" id="message-box">
            <h3>üîí ‡¶≠‡ßã‡¶ü ‡¶ó‡ßã‡¶™‡¶® ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá</h3>
            <p>‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ï‡ßá‡¶â ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('voters-tab')">üë• ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</button>
            <button class="tab" onclick="showTab('results-tab')">üìä ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</button>
        </div>

        <div id="voters-tab" class="tab-content active">
            <h2>‡¶≠‡ßã‡¶ü‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
            <div class="voters-list" id="voters-container">
                <div class="loading">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
            </div>
        </div>

        <div id="results-tab" class="tab-content">
            <h2>‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶≠‡ßã‡¶ü ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h2>
            <div class="results-grid" id="results-container">
                <div class="loading">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
            </div>
        </div>
    </div>

 <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        getDocs, 
        deleteDoc, 
        doc, 
        setDoc, 
        getDoc, 
        writeBatch,
        onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyChDeqEPatoWTUPoZpcYOSXcnAuoVJsV-c",
        authDomain: "apps-login-page.firebaseapp.com",
        projectId: "apps-login-page",
        storageBucket: "apps-login-page.firebasestorage.app",
        messagingSenderId: "601656721972",
        appId: "1:601656721972:web:20ce6efffc82b2e0b68061",
        measurementId: "G-RPPBB0C7BQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Notification function
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü
    const candidates = [
            { id: 1, name: "Aoual Sheikh", marker: "üêï", color: "#e74c3c" },
            { id: 2, name: "Afrin Sultana", marker: "ü¶í", color: "#3498db" },
            { id: 3, name: "Amio Biswas", marker: "üêì", color: "#2ecc71" },
            { id: 4, name: "Amrita Rani", marker: "ü¶ö", color: "#f39c12" },
            { id: 5, name: "Ashik Khan", marker: "üêã", color: "#9b59b6" },
            { id: 6, name: "Fahmida Sultana", marker: "üê¨", color: "#1abc9c" },
            { id: 7, name: "Esrat Jahan Emi", marker: "ü™≥", color: "#d35400" },
            { id: 8, name: "Fazle", marker: "ü™∞", color: "#c0392b" },
            { id: 9, name: "Sabbir Hosain", marker: "ü¶ü", color: "#16a085" },
            { id: 10, name: "Mahmuda Akter Sumee", marker: "üï∑Ô∏è", color: "#8e44ad" },
            { id: 11, name: "Itz Amirul", marker: "ü¶ñ", color: "#27ae60" },
            { id: 12, name: "Kawsar Alam", marker: "ü¶â", color: "#e67e22" },
            { id: 13, name: "Kazi Nazmul Hasan", marker: "üê•", color: "#2980b9" },
            { id: 14, name: "Lamis Shikder", marker: "ü™∂", color: "#f1c40f" },
            { id: 15, name: "Md Joni Islam", marker: "üêò", color: "#e91e63" },
            { id: 16, name: "Md Samiul Alam", marker: "üêô", color: "#00bcd4" },
            { id: 17, name: "Misbah Akter Mithila", marker: "üê±", color: "#795548" },
            { id: 18, name: "Tanvir Hassan", marker: "ü¶ì", color: "#607d8b" },
            { id: 19, name: "Mohon Talukder", marker: "ü¶å", color: "#3f51b5" },
            { id: 20, name: "Moriam Mim", marker: "ü¶©", color: "#009688" },
            { id: 21, name: "Nasrin Akter Tarin", marker: "üåµ", color: "#ff5722" },
            { id: 22, name: "Priti Das", marker: "üåπ", color: "#673ab7" },
            { id: 23, name: "Rayhan Hossain Hridoy", marker: "üíê", color: "#ff9800" },
            { id: 24, name: "Riyad Hossain", marker: "ü¶≠", color: "#2196f3" },
            { id: 25, name: "Sadia Sultana", marker: "üêå", color: "#4caf50" },
            { id: 26, name: "Saifa Ahmed", marker: "üêù", color: "#ffeb3b" },
            { id: 27, name: "Sakil Khan", marker: "üåª", color: "#9c27b0" },
            { id: 28, name: "Sanjida Khan Koli", marker: "üêú", color: "#00bcd4" },
            { id: 29, name: "Sakila Simi", marker: "ü¶ã", color: "#ffc107" },
            { id: 30, name: "Shojeb Rana", marker: "ü¶Ö", color: "#8bc34a" },
            { id: 31, name: "Sujoy Sarker", marker: "ü¶ú", color: "#e91e63" },
            { id: 32, name: "Tanjina Akter", marker: "üê¥", color: "#3f51b5" },
            { id: 33, name: "Tasrin Akter Bristy", marker: "ü••", color: "#009688" },
            { id: 34, name: "Tayba Haider Riya", marker: "üçÖ", color: "#ff5722" },
            { id: 35, name: "Md Roman Molla", marker: "üå∂Ô∏è", color: "#795548" },
            { id: 36, name: "Md Sujon Shikder", marker: "üåΩ", color: "#607d8b" },
            { id: 37, name: "Sadek Mia", marker: "üçâ", color: "#f44336" },
            { id: 38, name: "Md Rana Ahmed", marker: "üçÑ", color: "#4caf50" },
            { id: 39, name: "Md Saidul Haque", marker: "ü•≠", color: "#2196f3" }
    ];

    const settingsDoc = doc(db, "settings", "election");
    let resultsPublished = false;
    let unsubscribeVotes = null;
    let isConnected = false;
    let currentVotes = [];

    // Firebase connection status check
    function updateConnectionStatus(connected) {
        isConnected = connected;
        const indicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('connection-status');
        
        if (connected) {
            indicator.className = 'status-indicator status-online';
            statusText.textContent = 'Firebase Connected';
            statusText.style.color = '#27ae60';
        } else {
            indicator.className = 'status-indicator status-offline';
            statusText.textContent = 'Firebase Disconnected';
            statusText.style.color = '#e74c3c';
        }
    }

    // ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã
    async function loadInitialData() {
        try {
            console.log("Initializing admin panel...");
            await checkSettings();
            await loadResults();
            setupRealtimeListener();
            updateConnectionStatus(true);
            showNotification("‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá", "success");
        } catch (error) {
            console.error("Initialization error:", error);
            updateConnectionStatus(false);
            showNotification("‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
        }
    }

    async function checkSettings() {
        try {
            console.log("Checking settings...");
            const docSnap = await getDoc(settingsDoc);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                resultsPublished = data.resultsPublished || false;
                console.log("Settings found, resultsPublished:", resultsPublished);
            } else {
                console.log("No settings found, creating default...");
                await setDoc(settingsDoc, { 
                    resultsPublished: false,
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    totalCandidates: 39,
                    autoCreated: true
                });
                resultsPublished = false;
            }
            updateUI();
        } catch (error) {
            console.error("Settings error:", error);
            resultsPublished = false;
            updateUI();
        }
    }

    window.toggleResultsPublish = async function() {
        try {
            const newStatus = !resultsPublished;
            console.log("Toggling results publish to:", newStatus);
            
            const publishBtn = document.getElementById('publish-btn');
            publishBtn.textContent = '‚è≥ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£...';
            publishBtn.disabled = true;

            await setDoc(settingsDoc, { 
                resultsPublished: newStatus,
                lastUpdated: new Date().toISOString(),
                updatedBy: 'admin',
                totalCandidates: 39
            }, { merge: true });
            
            resultsPublished = newStatus;
            updateUI();
            
            const message = resultsPublished ? 
                '‚úÖ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶∏‡¶¨‡¶æ‡¶á ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§' : 
                'üîí ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶ó‡ßã‡¶™‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶ï‡ßá‡¶â ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§';
            
            showNotification(message, "success");
            await loadResults();
            
        } catch (error) {
            console.error("Toggle error:", error);
            showNotification('‚ùå ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + error.message, "error");
        } finally {
            const publishBtn = document.getElementById('publish-btn');
            publishBtn.disabled = false;
            updateUI();
        }
    }

    function updateUI() {
        const messageBox = document.getElementById('message-box');
        const publishBtn = document.getElementById('publish-btn');
        const resultsStatus = document.getElementById('results-status');
        const settingsInfo = document.getElementById('settings-info');

        if (resultsPublished) {
            messageBox.innerHTML = '<h3>‚úÖ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá</h3><p>‡¶è‡¶ñ‡¶® ‡¶∏‡¶¨‡¶æ‡¶á ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§</p>';
            messageBox.style.background = '#d4edda';
            messageBox.style.borderColor = '#c3e6cb';
            messageBox.style.color = '#155724';
            publishBtn.textContent = 'üôà ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶ó‡ßã‡¶™‡¶®';
            resultsStatus.textContent = '‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶ø‡¶§';
            settingsInfo.textContent = '‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶∏‡¶¨‡¶æ‡¶á ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá';
        } else {
            messageBox.innerHTML = '<h3>üîí ‡¶≠‡ßã‡¶ü ‡¶ó‡ßã‡¶™‡¶® ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá</h3><p>‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ï‡ßá‡¶â ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§</p>';
            messageBox.style.background = '#fff3cd';
            messageBox.style.borderColor = '#ffeaa7';
            messageBox.style.color = '#856404';
            publishBtn.textContent = 'üì¢ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂';
            resultsStatus.textContent = '‡¶ó‡ßã‡¶™‡¶®';
            settingsInfo.textContent = '‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶ó‡ßã‡¶™‡¶® ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá';
        }
    }

    window.loadResults = async function() {
        try {
            console.log("Loading results from Firebase...");
            const querySnapshot = await getDocs(collection(db, "votes"));
            currentVotes = [];
            
            querySnapshot.forEach((doc) => {
                currentVotes.push({ id: doc.id, ...doc.data() });
            });

            console.log("Total votes found:", currentVotes.length);
            updateStatistics(currentVotes);
            displayVotersList(currentVotes);
            
            if (resultsPublished) {
                displayResults(currentVotes);
            } else {
                document.getElementById('results-container').innerHTML = 
                    '<div class="message-box">üîí ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶è‡¶ñ‡¶®‡¶ì ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶ø‡¶§ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§</div>';
            }
            
        } catch (error) {
            console.error("Load error:", error);
            document.getElementById('voters-container').innerHTML = 
                '<div class="message-box">‚ùå ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + error.message + '</div>';
            document.getElementById('results-container').innerHTML = 
                '<div class="message-box">‚ùå ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + error.message + '</div>';
            updateConnectionStatus(false);
            showNotification('‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + error.message, "error");
        }
    }

    function updateStatistics(votes) {
        document.getElementById('total-votes').textContent = votes.length;

        if (resultsPublished && votes.length > 0) {
            const voteCount = {};
            candidates.forEach(candidate => {
                voteCount[candidate.name] = 0;
            });

            votes.forEach(vote => {
                if (vote.candidate1) voteCount[vote.candidate1]++;
                if (vote.candidate2) voteCount[vote.candidate2]++;
            });

            const sortedResults = Object.entries(voteCount).sort(([,a], [,b]) => b - a);
            const winner = sortedResults[0];
            
            document.getElementById('winner-name').textContent = winner[0];
            document.getElementById('winner-votes').textContent = winner[1] + ' ‡¶≠‡ßã‡¶ü';
        } else {
            document.getElementById('winner-name').textContent = '-';
            document.getElementById('winner-votes').textContent = '0 ‡¶≠‡ßã‡¶ü';
        }
    }

    function displayVotersList(votes) {
        const container = document.getElementById('voters-container');
        const sortedVotes = votes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        if (sortedVotes.length === 0) {
            container.innerHTML = '<div class="message-box">üìù ‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡ßã‡¶® ‡¶≠‡ßã‡¶ü ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</div>';
            return;
        }
        
        container.innerHTML = sortedVotes.map(vote => {
            const time = new Date(vote.timestamp).toLocaleString('bn-BD');
            return `
                <div class="voter-item">
                    <div>
                        <div style="font-weight: bold; color: #2c3e50;">${vote.voterName || 'Anonymous'}</div>
                        <div style="color: #7f8c8d; font-size: 0.9em;">
                            ‡¶≠‡ßã‡¶ü ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                        </div>
                    </div>
                    <div style="color: #95a5a6; font-size: 0.8em; text-align: right;">
                        <div>${time}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function displayResults(votes) {
        const container = document.getElementById('results-container');
        
        if (!resultsPublished) {
            container.innerHTML = '<div class="message-box">üîí ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶è‡¶ñ‡¶®‡¶ì ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶ø‡¶§ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§</div>';
            return;
        }

        const voteCount = {};
        candidates.forEach(candidate => {
            voteCount[candidate.name] = 0;
        });

        votes.forEach(vote => {
            if (vote.candidate1) voteCount[vote.candidate1]++;
            if (vote.candidate2) voteCount[vote.candidate2]++;
        });

        const sortedResults = Object.entries(voteCount)
            .sort(([,a], [,b]) => b - a)
            .filter(([,count]) => count > 0);

        const maxVotes = Math.max(...Object.values(voteCount));
        
        if (sortedResults.length === 0) {
            container.innerHTML = '<div class="message-box">üìä ‡¶ï‡ßã‡¶® ‡¶≠‡ßã‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</div>';
            return;
        }
        
        container.innerHTML = sortedResults.map(([candidateName, count], index) => {
            const candidate = candidates.find(c => c.name === candidateName);
            const percentage = maxVotes > 0 ? ((count / maxVotes) * 100).toFixed(1) : 0;
            const isWinner = index === 0 && count > 0;
            
            return `
                <div class="candidate-card ${isWinner ? 'winner' : ''}">
                    <div class="candidate-header">
                        <div class="candidate-marker" style="background: ${candidate?.color || '#666'}">
                            ${candidate?.marker || '?'}
                        </div>
                        <div class="candidate-info">
                            <div class="candidate-name">${candidateName}</div>
                            <div style="color: #7f8c8d; font-size: 0.9em;">
                                ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶æ: ${candidate?.marker || 'N/A'} | ${percentage}%
                            </div>
                        </div>
                        <div class="vote-count">${count}</div>
                    </div>
                    ${isWinner ? '<div style="text-align: center; color: #27ae60; font-weight: bold; margin-top: 10px;">üèÜ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶ø‡¶ú‡¶Ø‡¶º‡ßÄ</div>' : ''}
                </div>
            `;
        }).join('');
    }

    window.resetAllVotes = async function() {
        if (!confirm('‚ö†Ô∏è ‡¶∏‡¶¨ ‡¶≠‡ßã‡¶ü ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶è‡¶ü‡¶ø ‡¶∞‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶ø‡¶¨‡¶≤ ‡¶®‡ßü! ‡¶∏‡¶¨ ‡¶≠‡ßã‡¶ü ‡¶ö‡¶ø‡¶∞‡¶§‡¶∞‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá!')) {
            return;
        }

        if (!confirm('‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? ‡¶è‡¶á ‡¶è‡¶ï‡¶∂‡¶®‡¶ü‡¶ø undo ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!')) {
            return;
        }

        try {
            const querySnapshot = await getDocs(collection(db, "votes"));
            const batch = writeBatch(db);
            
            let deleteCount = 0;
            querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
                deleteCount++;
            });
            
            await batch.commit();
            showNotification(`‚úÖ ${deleteCount} ‡¶ü‡¶ø ‡¶≠‡ßã‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!`, "success");
            await loadResults();
        } catch (error) {
            console.error("Reset error:", error);
            showNotification('‚ùå ‡¶≠‡ßã‡¶ü ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + error.message, "error");
        }
    }

    window.exportToExcel = async function() {
        try {
            const querySnapshot = await getDocs(collection(db, "votes"));
            const votes = [];
            
            querySnapshot.forEach((doc) => {
                votes.push(doc.data());
            });

            const voteCount = {};
            candidates.forEach(candidate => {
                voteCount[candidate.name] = 0;
            });

            votes.forEach(vote => {
                if (vote.candidate1) voteCount[vote.candidate1]++;
                if (vote.candidate2) voteCount[vote.candidate2]++;
            });

            let csv = '‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ,‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶æ,‡¶≠‡ßã‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ\n';
            
            Object.entries(voteCount).forEach(([candidateName, count]) => {
                const candidate = candidates.find(c => c.name === candidateName);
                csv += `"${candidateName}","${candidate?.marker || ''}","${count}"\n`;
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `botany_election_results_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification(`‚úÖ ‡¶≠‡ßã‡¶ü ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ CSV ‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!`, "success");
        } catch (error) {
            console.error("Export error:", error);
            showNotification('‚ùå ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + error.message, "error");
        }
    }

    // ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∏‡ßç‡¶Ø‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® - FIXED VERSION
    window.showTab = function(tabName) {
        console.log("Switching to tab:", tabName);
        
        // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∏‡¶¨ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // ‡¶∏‡¶¨ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶•‡ßá‡¶ï‡ßá active ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        document.getElementById(tabName).classList.add('active');
        
        // ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá active ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
        event.target.classList.add('active');
        
        // ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®
        if (tabName === 'results-tab') {
            console.log("Loading results for results tab...");
            loadResults();
        }
    }

    function setupRealtimeListener() {
        if (unsubscribeVotes) {
            unsubscribeVotes();
        }
        
        unsubscribeVotes = onSnapshot(collection(db, "votes"), (snapshot) => {
            console.log("Real-time update received");
            loadResults();
            updateConnectionStatus(true);
        }, (error) => {
            console.error("Realtime listener error:", error);
            updateConnectionStatus(false);
        });

        // Settings ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡ßá‡¶ì real-time listener ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
        onSnapshot(settingsDoc, (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                resultsPublished = data.resultsPublished || false;
                console.log("Settings updated, resultsPublished:", resultsPublished);
                updateUI();
                loadResults();
            }
        });
    }

    // ‡¶™‡ßá‡¶á‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, initializing...");
        loadInitialData();
        
        // ‡¶Ö‡¶ü‡ßã ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ (‡¶™‡ßç‡¶∞‡¶§‡¶ø 30 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá)
        setInterval(() => {
            if (isConnected) {
                loadResults();
            }
        }, 30000);
    });

    // ‡¶™‡ßá‡¶á‡¶ú ‡¶Ü‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá listener ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
    window.addEventListener('beforeunload', function() {
        if (unsubscribeVotes) {
            unsubscribeVotes();
        }
    });
</script>
</body>
    </html>
